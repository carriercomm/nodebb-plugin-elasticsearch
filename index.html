<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Architects+Daughter' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/pygment_trac.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print" />

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <title>Nodebb-plugin-elasticsearch by seti123</title>
  </head>

  <body>
    <header>
      <div class="inner">
        <h1>Nodebb-plugin-elasticsearch</h1>
        <h2>adding advanced fulltext search to NodeBB</h2>
        <a href="https://github.com/seti123/nodebb-plugin-elasticsearch" class="button"><small>View project on</small>GitHub</a>
      </div>
    </header>

    <div id="content-wrapper">
      <div class="inner clearfix">
        <section id="main-content">
          <pre><code>TODO / open questions: 
1) How to hook into post changes?
2) How to redirect the search submit action to the plugin custom route?
      - I made a fork of NodeBB
         if you use it go to admin / settings / posts and disabel DB search
         then install the plugin as described below
         (pull request made)


What works:
- indexing new posts to local ES server (localhost:9200)
- automatic index creation "nodebb_posts"
- automatic setting of index mapping for autocompletion 
- custom routes are /nodebb-plugin-elasticsearch/search/:term and /elasticsearch/search:term
- on plugin activation in NodeBB admin GUI, ALL existing posts are indexed automatically
   TODO: store last index date, and index only new ... well but plugin 
   might be activated only once, and it might be an option to trigger the process
   again e.g after changing ES server ...
- search with elasticsearch on my NodeBB fork seti123/NodeBB

</code></pre>

<h1>
<a name="installation-on-debian" class="anchor" href="#installation-on-debian"><span class="octicon octicon-link"></span></a>Installation (on Debian)</h1>

<h2>
<a name="1-elasticsearch-server" class="anchor" href="#1-elasticsearch-server"><span class="octicon octicon-link"></span></a>1) ElasticSearch server</h2>

<pre><code>apt-get install openjdk-7-jre-headless -y
wget https://download.elasticsearch.org/elasticsearch/elasticsearch/elasticsearch-0.90.6.deb
dpkg -i elasticsearch-0.90.6.deb
## install some useful plugins
/usr/share/elasticsearch/bin/plugin -install mobz/elasticsearch-head
/usr/share/elasticsearch/bin/plugin --install jettro/elasticsearch-gui 

open browser and go to http://localhost:9200/_plugin/head
</code></pre>

<h2>
<a name="2-nodebb-plugin" class="anchor" href="#2-nodebb-plugin"><span class="octicon octicon-link"></span></a>2) NodeBB plugin</h2>

<pre><code>   npm install seti123/nodebb-plugin-elasticsearch
</code></pre>

<h2>
<a name="3-restart-nodebb-nodebb-dev-activate-plugin-in-admin-and-make-some-posts-in-nodebb" class="anchor" href="#3-restart-nodebb-nodebb-dev-activate-plugin-in-admin-and-make-some-posts-in-nodebb"><span class="octicon octicon-link"></span></a>3) restart NodeBB (./nodebb dev), activate plugin in admin and make some posts in nodeBB</h2>

<pre><code># to see plugin loading and debug out put ...
./nodebb dev
</code></pre>

<p>On the console you should see some dub messages about indexing all posts ...</p>

<h2>
<a name="4-check-autocomplete-feature-or-search" class="anchor" href="#4-check-autocomplete-feature-or-search"><span class="octicon octicon-link"></span></a>4) Check autocomplete feature or search</h2>

<pre><code>curl -X POST localhost:9200/nodebb_posts/_suggest -d '
{
  "nodebb_posts" : {
    "text" : "ElasticSearch",
    "completion" : {
      "field" : "content_suggest"
    }
  }
}'
</code></pre>

<p>Title suggested for autocomplete:</p>

<pre><code>{"_shards":{"total":5,"successful":5,"failed":0},"nodebb_posts":[{"text":"ElasticSearch","offset":0,"length":13,"options":[{"text":"Another new blog","score":1.0}]}]}
</code></pre>

<p>Lets search</p>

<pre><code>1) curl localhost:9200/nodebb_posts/_search?q=new
</code></pre>

<p>OR on NodeBB assuming on localhost</p>

<pre><code>1) http://localhost/elasticsearch/*
</code></pre>

<p>Result 1):</p>

<pre><code>{

    "took": 3,
    "timed_out": false,
    "_shards": {
        "total": 5,
        "successful": 5,
        "failed": 0
    },
    "hits": {
        "total": 2,
        "max_score": 0.25,
        "hits": [
            {
                "_index": "nodebb_posts",
                "_type": "nodebb_posts",
                "_id": "26",
                "_score": 0.25,
                "_source": {
                    "pid": 26,
                    "uid": "1",
                    "tid": 23,
                    "content": "&lt;p&gt;this is the first blog entry with ElasticSearch support&lt;/p&gt;\n",
                    "timestamp": 1389789466903,
                    "reputation": 0,
                    "editor": "",
                    "edited": 0,
                    "deleted": 0,
                    "title": "A new blog",
                    "content_suggest": [
                        "A new blog",
                        "&lt;p&gt;this is the first blog entry with ElasticSearch support&lt;/p&gt;\n"
                    ]
                }
            },

            ....
</code></pre>

<p>Result 2) in NodeBB</p>

<pre><code>{

    "show_no_topics": "hide",
    "show_no_posts": "hide",
    "show_results": "",
    "search_query": "*",
    "posts": [
        {
            "pid": "27",
            "tid": "24",
            "content": "&lt;p&gt;My second entry with ElasticSearch support&lt;/p&gt;\n",
            "uid": "1",
            "timestamp": "1389789491362",
            "deleted": "0",
            "fields": [
                "pid",
                "tid",
                "content",
                "uid",
                "timestamp",
                "deleted"
            ],
            "relativeTime": "2014-01-15T12:38:11.362Z",
            "username": "admin",
            "userslug": "admin",
            "user_rep": "1",
            "user_postcount": "37",
            "user_banned": false,
            "picture": "http://www.gravatar.com/avatar/9760b45791726e6374884945d694c57a?size=128&amp;default=identicon&amp;rating=pg",
            "signature": "",
            "additional_profile_info": "",
            "editorname": null,
            "editorslug": null,
            "categoryName": "Blogs",
            "categoryIcon": "fa-pencil",
            "categorySlug": "4/blogs",
            "title": "2nd entry",
            "topicSlug": "24/2nd-entry"
        },
        {
            "pid": "34",
            "tid": "31",
            "content": "&lt;p&gt;Amazing what you can do with ElasticSearch&lt;/p&gt;\n",
            ...
</code></pre>
        </section>

        <aside id="sidebar">
          <a href="https://github.com/seti123/nodebb-plugin-elasticsearch/zipball/master" class="button">
            <small>Download</small>
            .zip file
          </a>
          <a href="https://github.com/seti123/nodebb-plugin-elasticsearch/tarball/master" class="button">
            <small>Download</small>
            .tar.gz file
          </a>

          <p class="repo-owner"><a href="https://github.com/seti123/nodebb-plugin-elasticsearch"></a> is maintained by <a href="https://github.com/seti123">seti123</a>.</p>

          <p>This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the Architect theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.</p>
        </aside>
      </div>
    </div>

  
  </body>
</html>